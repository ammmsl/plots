<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer Island Load Variation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.24.1/plotly.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            width: 250px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .plot-container {
            flex: 1;
            min-height: 600px;
        }
        .group {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .group-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            cursor: pointer;
            user-select: none;
        }
        .group-header:hover {
            color: #007bff;
        }
        .group-items {
            margin-left: 10px;
        }
        .checkbox-item {
            margin: 5px 0;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .select-all-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .select-all-btn:hover {
            background-color: #0056b3;
        }
        .deselect-all-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .deselect-all-btn:hover {
            background-color: #545b62;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            max-width: 500px;
            z-index: 1001;
        }
        
        .popup h3, .popup h4 {
            margin-top: 0;
            color: #333;
        }
        
        .popup hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }
        
        .popup p {
            margin: 8px 0;
            line-height: 1.4;
        }
        
        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        .popup-close:hover {
            color: #000;
        }
        
    </style>
</head>
<body>
<!--     <h1>Summer Island Load Variation</h1> -->
    <div class="container">
        <div class="controls">
            <div style="margin-bottom: 15px;">
                <button class="select-all-btn" onclick="selectAll()">Select All</button>
                <button class="deselect-all-btn" onclick="deselectAll()">Deselect All</button>
            </div>
            
            <div class="group">
                <div class="group-header" onclick="toggleGroup('load')">
                    <input type="checkbox" id="group-load" onchange="toggleGroupSelection('load')" checked>
                    üìä Load
                </div>
                <div class="group-items" id="load-items">
                    <div class="checkbox-item">
                        <input type="checkbox" id="present-load" class="group-load" checked>
                        <label for="present-load">Present Load</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="predicted-load" class="group-load" checked>
                        <label for="predicted-load">Predicted Load</label>
                    </div>
                </div>
            </div>

            <div class="group">
                <div class="group-header" onclick="toggleGroup('solar')">
                    <input type="checkbox" id="group-solar" onchange="toggleGroupSelection('solar')" checked>
                    ‚òÄÔ∏è Solar
                </div>
                <div class="group-items" id="solar-items">
                    <div class="checkbox-item">
                        <input type="checkbox" id="solar-power" class="group-solar" checked>
                        <label for="solar-power">Solar Power</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="diesel-demand" class="group-solar" checked>
                        <label for="diesel-demand">Diesel Demand</label>
                    </div>
                </div>
            </div>

            <div class="group">
                <div class="group-header" onclick="toggleGroup('current')">
                    <input type="checkbox" id="group-current" onchange="toggleGroupSelection('current')">
                    üîß Current Configurations
                </div>
                <div class="group-items" id="current-items">
                    <div class="checkbox-item">
                        <input type="checkbox" id="810-575-75" class="group-current">
                        <label for="810-575-75">810+575 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="810-200-75" class="group-current">
                        <label for="810-200-75">810+200 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="200-638-75" class="group-current">
                        <label for="200-638-75">200+638 75%</label>
                    </div>                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="810-75" class="group-current">
                        <label for="810-75">810 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="638-75" class="group-current">
                        <label for="638-75">638 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="575-75" class="group-current">
                        <label for="575-75">575 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="200-75" class="group-current">
                        <label for="200-75">200 75%</label>
                    </div>
                </div>
            </div>

            <div class="group">
                <div class="group-header" onclick="toggleGroup('250kva')">
                    <input type="checkbox" id="group-250kva" onchange="toggleGroupSelection('250kva')">
                    ‚ö° 250kVA Unit
                </div>
                <div class="group-items" id="250kva-items">
                    <div class="checkbox-item">
                        <input type="checkbox" id="810-250vp-75" class="group-250kva">
                        <label for="810-250vp-75">810+250(VP) 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="638-250vp-75" class="group-250kva">
                        <label for="638-250vp-75">638+250(VP) 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="575-250vp-75" class="group-250kva">
                        <label for="575-250vp-75">575+250(VP) 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="200-250vp-75" class="group-250kva">
                        <label for="200-250vp-75">200+250(VP) 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="250kva-75" class="group-250kva">
                        <label for="250kva-75">250kVA 75%</label>
                    </div>
                </div>
            </div>

            <div class="group">
                <div class="group-header" onclick="toggleGroup('650kva')">
                    <input type="checkbox" id="group-650kva" onchange="toggleGroupSelection('650kva')">
                    ‚ö° 650kVA Unit
                </div>
                <div class="group-items" id="650kva-items">
                    <div class="checkbox-item">
                        <input type="checkbox" id="810-650vp-75" class="group-650kva">
                        <label for="810-650vp-75">810+650(VP) 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="638-650vp-75" class="group-650kva">
                        <label for="638-650vp-75">638+650(VP) 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="575-650vp-75" class="group-650kva">
                        <label for="575-650vp-75">575+650(VP) 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="200-650vp-75" class="group-650kva">
                        <label for="200-650vp-75">200+650(VP) 75%</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="650kva-75" class="group-650kva">
                        <label for="650kva-75">650kVA 75%</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="plot-container">
            <div id="plot" style="width: 100%; height: 600px;"></div>
        </div>
        <div id="popup-overlay" class="popup-overlay" onclick="closePopup()">
            <div class="popup" onclick="event.stopPropagation()">
                <button class="popup-close" onclick="closePopup()">&times;</button>
                <div id="popup-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Data
        const data = {
            time: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],
            'Present Load': [230, 237.1555765, 258.1346652, 291.507576, 335, 385.6480005, 440, 494.3519995, 545, 588.492424, 621.8653348, 642.8444235, 650, 642.8444235, 621.8653348, 588.492424, 545, 494.3519995, 440, 385.6480005, 335, 291.507576, 258.1346652, 237.1555765, 230],
            'Predicted Load': [272.728913,264.5,272.728913,296.854865,335.2337123,385.25,443.4952006,506,568.5047994,626.75,676.7662877,715.145135,739.271087,747.5,739.271087,715.145135,676.7662877,626.75,568.5047994,506,443.4952006,385.25,335.2337123,296.854865,272.728913],
            'Solar Power': [0,0,0,0,0,0,0,182.8401262,353.22,499.5285145,611.7949862,682.3686407,706.44,682.3686407,611.7949862,499.5285145,353.22,182.8401262,8.65494E-14,0,0,0,0,0,0],
            'Diesel Demand': [237.2,230.0,237.2,258.1,291.5,335.0,385.6,257.2,141.1,45.5,-23.3,-60.5,-63.6,-32.4,31.0,122.3,235.3,362.2,494.4,440.0,385.6,335.0,291.5,258.1,237.2],
            '810+575 75%': [833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833,833],
            '810 75%': [488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488,488],
            '810+200 75%': [608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608,608],
            '200+638 75%': [501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501,501],
            '575 75%': [345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345,345],
            '200 75%': [120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120],
            '638 75%': [381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381,381],
            '250kVA 75%': [150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150],
            '650kVA 75%': [390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390,390],
            '575+250(VP) 75%': [495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495,495],
            '810+250(VP) 75%': [638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638,638],
            '200+250(VP) 75%': [270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270],
            '638+250(VP) 75%': [531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531,531],
            '575+650(VP) 75%': [735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735,735],
            '810+650(VP) 75%': [878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878,878],
            '200+650(VP) 75%': [510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510,510],
            '638+650(VP) 75%': [771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771,771]
        };
        data['Predicted Load'] = data['Present Load'].map(load => load * 1.15);
        data['Diesel Demand'] = data['Present Load'].map((load, index) => load - data['Solar Power'][index]);
        let selectedPoints = [];
        let selectedAreaPoints = [];
        let areaPopupVisible = false;
        
        // Add event listener after plot creation
        function addClickListener() {
            document.getElementById('plot').on('plotly_click', handlePlotClick);
        }
        function handlePlotClick(data) {
            const point = data.points[0];
            const clickedPoint = {
                x: point.x,
                y: point.y,
                seriesName: point.data.name
            };
            
            // Close area popup if it's visible and start new area calculation
            if (areaPopupVisible) {
                areaPopupVisible = false;
                selectedAreaPoints = [];
                handleAreaClick(data);  // Start new area calculation
                return;
            }
            
            selectedPoints.push(clickedPoint);
            
            if (selectedPoints.length === 2) {
                // Check if both points have same x value for point difference
                if (selectedPoints[0].x === selectedPoints[1].x) {
                    showDifferencePopup();
                } else {
                    // Different x values - calculate area between series
                    selectedPoints = []; // Reset point selection
                    selectedAreaPoints = []; // Reset area selection
                    handleAreaClick(data); // Start area calculation
                }
            } else if (selectedPoints.length > 2) {
                selectedPoints = [clickedPoint]; // Start new selection
            }
        }
        function calculateEnergy(dataArray) {
            let totalEnergy = 0;
            
            // Using trapezoidal rule for integration
            for (let i = 0; i < dataArray.length - 1; i++) {
                const timeStep = 1; // 1 hour intervals
                const avgPower = (dataArray[i] + dataArray[i + 1]) / 2;
                totalEnergy += avgPower * timeStep; // kW * hours = kWh
            }
            
            return totalEnergy;
        }
        function showDifferencePopup() {
            const point1 = selectedPoints[0];
            const point2 = selectedPoints[1];
            const pointDifference = Math.abs(point2.y - point1.y);
            
            // Get the full data arrays for both series
            const series1Data = data[point1.seriesName];
            const series2Data = data[point2.seriesName];
            
            // Calculate total energy for each series
            const energy1 = calculateEnergy(series1Data);
            const energy2 = calculateEnergy(series2Data);
            const energyDifference = Math.abs(energy2 - energy1);
            
            const content = `
                <h3>Load Difference & Energy Analysis</h3>
                <p><strong>Time:</strong> ${point1.x}:00 hours</p>
                
                <h4>Point Comparison:</h4>
                <p><strong>Point 1:</strong> ${point1.seriesName} = ${point1.y.toFixed(1)} kW</p>
                <p><strong>Point 2:</strong> ${point2.seriesName} = ${point2.y.toFixed(1)} kW</p>
                <p><strong>Point Difference:</strong> ${pointDifference.toFixed(1)} kW</p>
                
                <hr>
                
                <h4>24-Hour Energy Analysis:</h4>
                <p><strong>${point1.seriesName}:</strong> ${energy1.toFixed(1)} kWh</p>
                <p><strong>${point2.seriesName}:</strong> ${energy2.toFixed(1)} kWh</p>
                <p><strong>Energy Difference:</strong> ${energyDifference.toFixed(1)} kWh</p>
                
            `;
            
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup-overlay').style.display = 'block';
            
            selectedPoints = []; // Reset selection
        }
        
        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
            areaPopupVisible = false;
            selectedAreaPoints = [];
        }
        function findIntersections(series1Data, series2Data, timeData) {
            const intersections = [];
            
            for (let i = 0; i < series1Data.length - 1; i++) {
                const x1 = timeData[i];
                const x2 = timeData[i + 1];
                const y1_s1 = series1Data[i];
                const y2_s1 = series1Data[i + 1];
                const y1_s2 = series2Data[i];
                const y2_s2 = series2Data[i + 1];
                
                // Check if lines intersect (different signs of difference)
                const diff1 = y1_s1 - y1_s2;
                const diff2 = y2_s1 - y2_s2;
                
                if (diff1 * diff2 < 0) { // Lines cross
                    // Linear interpolation to find intersection point
                    const t = Math.abs(diff1) / (Math.abs(diff1) + Math.abs(diff2));
                    const intersectX = x1 + t * (x2 - x1);
                    const intersectY = y1_s1 + t * (y2_s1 - y1_s1);
                    
                    intersections.push({
                        x: intersectX,
                        y: intersectY,
                        index: i + t
                    });
                }
            }
            
            return intersections;
        }
        
        function calculateAreaBetweenSeries(series1Data, series2Data, startIndex, endIndex) {
            let area = 0;
            const step = 0.1; // Higher resolution for more accurate area calculation
            
            for (let i = startIndex; i < endIndex; i += step) {
                const floorI = Math.floor(i);
                const ceilI = Math.min(Math.ceil(i), series1Data.length - 1);
                const t = i - floorI;
                
                // Linear interpolation
                const y1 = series1Data[floorI] + t * (series1Data[ceilI] - series1Data[floorI]);
                const y2 = series2Data[floorI] + t * (series2Data[ceilI] - series2Data[floorI]);
                
                area += Math.abs(y1 - y2) * step;
            }
            
            return area;
        }
        
        function handleAreaClick(clickData) {
            const point = clickData.points[0];
            const clickedX = point.x;
            const seriesName = point.data.name;
            
            // Find all series that have data at this point
            const availableSeries = [];
            Object.keys(data).forEach(key => {
                if (key !== 'time' && data[key]) {
                    const checkbox = document.querySelector(`input[type="checkbox"][id*="${key.toLowerCase().replace(/[^a-z0-9]/g, '-')}"]`);
                    if (checkbox && checkbox.checked) {
                        availableSeries.push(key);
                    }
                }
            });
            
            if (availableSeries.length < 2) {
                alert("Please select at least 2 series to calculate area between them");
                return;
            }
            
            selectedAreaPoints.push({
                x: clickedX,
                seriesName: seriesName,
                availableSeries: availableSeries
            });
            
            if (selectedAreaPoints.length === 2) {
                calculateAndShowArea();
            } else if (selectedAreaPoints.length > 2) {
                selectedAreaPoints = [selectedAreaPoints[selectedAreaPoints.length - 1]]; // Keep only the latest point
            }
        }
        
        function calculateAndShowArea() {
            if (selectedAreaPoints.length !== 2) return;
            
            const point1 = selectedAreaPoints[0];
            const point2 = selectedAreaPoints[1];
            
            // Find common series between the two points
            const commonSeries = point1.availableSeries.filter(series => 
                point2.availableSeries.includes(series)
            );
            
            if (commonSeries.length < 2) {
                alert("Not enough common series between selected points");
                selectedAreaPoints = [];
                return;
            }
            
            const startX = Math.min(point1.x, point2.x);
            const endX = Math.max(point1.x, point2.x);
            
            // Calculate area between first two common series
            const series1Name = commonSeries[0];
            const series2Name = commonSeries[1];
            const series1Data = data[series1Name];
            const series2Data = data[series2Name];
            
            const area = calculateAreaBetweenSeries(series1Data, series2Data, startX, endX);
            const energyDifference = area; // Since we're dealing with power over time
            
            showAreaPopup(series1Name, series2Name, startX, endX, energyDifference);
        }
        
        function showAreaPopup(series1Name, series2Name, startX, endX, energyDifference) {
            const content = `
                <h3>Area Between Series</h3>
                <p><strong>Time Range:</strong> ${startX.toFixed(1)} - ${endX.toFixed(1)} hours</p>
                <p><strong>Series 1:</strong> ${series1Name}</p>
                <p><strong>Series 2:</strong> ${series2Name}</p>
                <p><strong>Area Difference:</strong> ${energyDifference.toFixed(1)} kWh</p>
                <p><em>Click another point to calculate new area</em></p>
            `;
            
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup-overlay').style.display = 'block';
            areaPopupVisible = true;
            
            selectedAreaPoints = []; // Reset selection
        }
                
        function updateLegendWithEnergy() {
            // Calculate and display energy for all visible series
            Object.keys(data).forEach(seriesName => {
                if (seriesName !== 'time') {
                    const energy = calculateEnergy(data[seriesName]);
                    console.log(`${seriesName}: ${energy.toFixed(1)} kWh`);
                }
            });
        }
        
        // Configuration for different groups
        const groups = {
            load: {
                color: ['#228B22', '#32CD32'], // Green tones
                series: ['Present Load', 'Predicted Load'],
                mode: 'markers+lines',
                symbols: ['circle', 'square'],
                ids: ['present-load', 'predicted-load']
            },
            solar: {
                color: ['#FF8C00', '#FF6347'], // Orange tones
                series: ['Solar Power', 'Diesel Demand'],
                mode: 'markers+lines',
                symbols: ['diamond', 'triangle-up'],
                ids: ['solar-power', 'diesel-demand']
            },
            current: {
                color: ['#4169E1', '#1E90FF', '#00BFFF', '#87CEEB', '#6495ED', '#B0C4DE', '#4682B4'], // Extended blue tones
                series: ['810+575 75%', '810 75%', '810+200 75%', '200+638 75%', '575 75%', '200 75%', '638 75%'],
                mode: 'lines',
                dash: ['solid', 'dash', 'dot', 'dashdot', 'longdash', 'longdashdot', '5,5,1,5'],
                ids: ['810-575-75', '810-75', '810-200-75', '200-638-75', '575-75', '200-75', '638-75']
            },
            '250kva': {
                color: ['#DC143C', '#B22222', '#FF1493', '#C71585', '#8B0000'], // Red/Pink tones
                series: ['575+250(VP) 75%', '810+250(VP) 75%', '200+250(VP) 75%', '638+250(VP) 75%', '250kVA 75%'],
                mode: 'lines',
                dash: ['solid', 'dash', 'dot', 'dashdot', 'longdash'],
                ids: ['575-250vp-75', '810-250vp-75', '200-250vp-75', '638-250vp-75', '250kva-75']
            },
            '650kva': {
                color: ['#9370DB', '#8A2BE2', '#9932CC', '#BA55D3', '#4B0082'], // Purple tones
                series: ['575+650(VP) 75%', '810+650(VP) 75%', '200+650(VP) 75%', '638+650(VP) 75%', '650kVA 75%'],
                mode: 'lines',
                dash: ['solid', 'dash', 'dot', 'dashdot', 'longdash'],
                ids: ['575-650vp-75', '810-650vp-75', '200-650vp-75', '638-650vp-75', '650kva-75']
            }
        };

        function createPlot() {
            const traces = [];
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                group.series.forEach((seriesName, index) => {
                    const checkbox = document.getElementById(group.ids[index]);
                    
                    if (checkbox && checkbox.checked) {
                        const trace = {
                            x: data.time,
                            y: data[seriesName],
                            name: seriesName,
                            type: 'scatter',
                            mode: group.mode,
                            line: {
                                color: group.color[index],
                                width: 2
                            },
                            marker: {
                                color: group.color[index],
                                size: 6
                            }
                        };

                        if (group.symbols) {
                            trace.marker.symbol = group.symbols[index];
                        }

                        if (group.dash) {
                            trace.line.dash = group.dash[index];
                        }

                        traces.push(trace);
                    }
                });
            });

            const layout = {
                title: {
                    text: 'Summer Island Load Variation',
                    font: { size: 20 }
                },
                xaxis: {
                    title: 'Time (hr)',
                    gridcolor: '#e6e6e6'
                },
                yaxis: {
                    title: 'Load (kW)',
                    gridcolor: '#e6e6e6'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                legend: {
                    x: 1.02,
                    y: 1,
                    orientation: 'v'
                },
                margin: {
                    l: 80,
                    r: 150,
                    t: 60,
                    b: 60
                }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian', 'toggleSpikelines'],
                displaylogo: false
            };

            Plotly.newPlot('plot', traces, layout, config);
            
            addClickListener();
        }

        function toggleGroup(groupName) {
            const items = document.getElementById(groupName + '-items');
            if (items.style.display === 'none') {
                items.style.display = 'block';
            } else {
                items.style.display = 'none';
            }
        }

        function toggleGroupSelection(groupName) {
            const groupCheckbox = document.getElementById('group-' + groupName);
            const itemCheckboxes = document.querySelectorAll('.group-' + groupName);
            
            itemCheckboxes.forEach(cb => {
                cb.checked = groupCheckbox.checked;
            });
            
            createPlot();
        }

        function updateGroupCheckbox(groupName) {
            const itemCheckboxes = document.querySelectorAll('.group-' + groupName);
            const groupCheckbox = document.getElementById('group-' + groupName);
            
            const checkedCount = Array.from(itemCheckboxes).filter(cb => cb.checked).length;
            
            if (checkedCount === 0) {
                groupCheckbox.checked = false;
                groupCheckbox.indeterminate = false;
            } else if (checkedCount === itemCheckboxes.length) {
                groupCheckbox.checked = true;
                groupCheckbox.indeterminate = false;
            } else {
                groupCheckbox.checked = false;
                groupCheckbox.indeterminate = true;
            }
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            createPlot();
        }

        function deselectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            createPlot();
        }

        // Add event listeners to all checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:not([id^="group-"])');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Update group checkbox state
                    const groups = ['load', 'solar', 'current', '250kva', '650kva'];
                    groups.forEach(groupName => {
                        if (checkbox.classList.contains('group-' + groupName)) {
                            updateGroupCheckbox(groupName);
                        }
                    });
                    createPlot();
                });
            });
            
            // Initial plot
            createPlot();
        });
    </script>
</body>
</html>
